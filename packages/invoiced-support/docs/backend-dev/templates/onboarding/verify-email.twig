{% trans_default_domain 'general' %}
{% set title='Verify Email' %}
{% extends "onboarding/parent.twig" %}

{% block main %}

    <div class="container-lg container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-8">
                <form class="py-6" method="post" id="theForm">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('onboarding') }}" />
                    <div class="row justify-content-center">
                        <div class="col-12 col-md-10 col-lg-8 col-xl-6 text-center">
                            <h6 class="mb-4 text-uppercase text-muted">
                                Step {{ currentStepNumber }} of {{ totalSteps }}
                            </h6>

                            <h1 class="mb-3">
                                First, let's verify your email address.
                            </h1>

                            <p class="mb-5 text-secondary">
                                Please check your inbox for an email with the subject "Please verify your email address". Then enter the code in the email here.
                            </p>

                            {% for error in errors %}
                                <div class="text-danger mb-4" role="alert">{{ error }}</div>
                            {% endfor %}

                            {% for message in app.flashes('verify_email') %}
                                <div class="text-success mb-4">{{ message }}</div>
                            {% endfor %}

                            <div class="form-group text-start">
                                <label class="form-label">
                                    Verification Code
                                </label>

                                <input type="hidden" name="email" value="{{ company.email }}" />
                                <input type="hidden" id="verifyEmailCode" name="code" />
                                <div id="verifyCode" class="d-flex justify-content-center verify-email-code">
                                    <input class="form-control m-2" type="text" id="first" maxlength="1" required="required" />
                                    <input class="form-control m-2" type="text" id="second" maxlength="1" required="required" />
                                    <input class="form-control m-2" type="text" id="third" maxlength="1" required="required" />
                                    <input class="form-control m-2" type="text" id="fourth" maxlength="1" required="required" />
                                    <input class="form-control m-2" type="text" id="fifth" maxlength="1" required="required" />
                                    <input class="form-control m-2" type="text" id="sixth" maxlength="1" required="required" />
                                </div>

                                <div class="mt-3">
                                    <a href="{{ path(isFakeFlow ? 'onboarding_resend_verification_email_fake' : 'onboarding_resend_verification_email', {companyId: app.request.attributes.get('companyId'), email: company.email}) }}">
                                        Resend Code
                                    </a>
                                </div>
                            </div>

                            <hr class="my-5">

                            <div class="nav row align-items-center justify-content-center text-center" role="tablist">
                                <div class="col">
                                    {% if previousStep %}
                                        <a href="{{ path('onboarding_step', {step: previousStep, companyId: app.request.attributes.get('companyId')}) }}" class="btn btn-lg btn-white">
                                            Previous
                                        </a>
                                    {% endif %}
                                </div>
                                <div class="col">
                                    <h6 class="text-uppercase text-muted mb-0">
                                        Step {{ currentStepNumber }} of {{ totalSteps }}
                                    </h6>
                                </div>
                                <div class="col">
                                    <button type="submit" class="btn btn-lg btn-primary" id="verifyEmailSubmit">
                                        Continue
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $(function () {
            {# Borrowed from https://gist.github.com/midhunmonachan/3c2fb506cab7e63ffbbd94080a0d2d80 #}
            const inputs = document.querySelectorAll('#verifyCode > *[id]');
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('keydown', function (event) {
                    if (event.key === "Backspace") {
                        if (inputs[i].value === '') {
                            if (i !== 0) {
                                inputs[i - 1].focus();
                            }
                        } else {
                            inputs[i].value = '';
                        }
                    } else if (event.key === "Enter") {
                        document.getElementById('verifyEmailSubmit').click();
                        return false;
                    } else if (event.key === "ArrowLeft" && i !== 0) {
                        inputs[i - 1].focus();
                    } else if (event.key === "ArrowRight" && i !== inputs.length - 1) {
                        inputs[i + 1].focus();
                    } else if (event.key !== "ArrowLeft" && event.key !== "ArrowRight") {
                        inputs[i].setAttribute("type", "text");
                        inputs[i].value = '';
                    }
                });
                inputs[i].addEventListener('input', function() {
                    inputs[i].value = inputs[i].value.toUpperCase();
                    if (i === inputs.length - 1 && inputs[i].value !== '') {
                        return true;
                    } else if (inputs[i].value !== '') {
                        inputs[i + 1].focus();
                    }
                });
                inputs[i].addEventListener('paste', function (event) {
                    event.preventDefault();
                    let text = (event.clipboardData || window.clipboardData).getData('text');
                    let chars = text.replace(/^\s+|\s+$/gm,'').split('');
                    console.log(chars);
                    for (let j = 0; j < chars.length; j++) {
                        if (typeof inputs[j] !== 'undefined') {
                            inputs[j].value = chars[j];
                        } else {
                            break;
                        }
                    }
                });
            }

            document.getElementById('verifyEmailSubmit').addEventListener('click', function() {
                const inputs = document.querySelectorAll('#verifyCode > *[id]');
                let compiledCode = '';
                for (let i = 0; i < inputs.length; i++) {
                    compiledCode += inputs[i].value;
                }
                document.getElementById('verifyEmailCode').value = compiledCode;
                return true;
            });

            $('#theForm').on('submit', function () {
                $('#verifyEmailSubmit').attr('disabled', 'disabled');
                return true;
            });
        });
    </script>
{% endblock %}
