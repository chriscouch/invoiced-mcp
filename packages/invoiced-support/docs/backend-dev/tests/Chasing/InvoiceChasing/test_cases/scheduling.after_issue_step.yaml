# Tests that "After issue" step
# - Should not be scheduled if (invoice date + days after) is in the past
# - Should be scheduled if (invoice date + days after) is in the future
# - Should be canceled if updated, not sent and (invoice date + days after) is in the past
#-  Should be uncanceled if updated (was in the past) and (invoice date + days after) is in the future

operations:

  # PART 1: Test that no ScheduledSend is created for a date in the past

  - operation: create
    mock_time: '2022-01-08 09:31:14' # Time chosen at random
    data:
      invoice:
        date: '2022-01-06 09:31:14' # Backdated invoice
        due_date: '2022-12-06 09:31:14' # Date calculation should be independent of due_date
        items:
          - quantity: 1
            unit_cost: 100
      delivery:
        chase_schedule:
          - trigger: 5
            options:
              hour: 8
              days: 1 # 2022-01-07
              email: true
              sms: false
              letter: false
    expect:
      delivery:
        processed: false
      delivery_state:
        - state:
            - date: '2022-01-07 08:00:00'
              skipped: true
              sent:
                email: false
      scheduled_sends: []

  - operation: schedule
    mock_time: '2022-01-08 09:31:14' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-07 08:00:00'
              skipped: true
              sent:
                email: false
      scheduled_sends: []

    # PART 2: Test that a ScheduledSend is created after the invoice date is updated to a future date
    # and the delivery is reprocessed.

  - operation: edit
    mock_time: '2022-01-08 09:31:14' # Same as previous
    data:
      invoice:
        date: '2022-01-08 09:31:14'
    expect:
      delivery:
        processed: false
      delivery_state:
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends: []

  - operation: schedule
    mock_time: '2022-01-08 09:31:14' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends:
        - send_after: '2022-01-09 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false

    # PART 3: Test that the ScheduledSend for the step is canceled when the invoice
    # date is updated such that (invoice date + days after option) is in the past
    # We update the invoice date for this test case for the same reason as PART 2.

  - operation: edit
    mock_time: '2022-01-08 09:31:14' # Same as previous
    data:
      invoice:
        date: '2022-01-06 09:31:14' # Backdated invoice
    expect:
      delivery:
        processed: false
      delivery_state:
        - state:
            - date: '2022-01-07 08:00:00'
              skipped: true
              sent:
                email: false
      scheduled_sends: # hasn't been updated yet
        - send_after: '2022-01-09 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false

  - operation: schedule
    mock_time: '2022-01-08 09:31:14' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-07 08:00:00'
              skipped: true
              sent:
                email: false
      scheduled_sends:
        - send_after: '2022-01-07 08:00:00'
          channel: 0
          sent: false
          canceled: true # Should be canceled now
          skipped: false
          failed: false

    # PART 4: Test that the ScheduledSend for the step is un-canceled when the invoice date
    # is updated to cause (invoice date + days after option) to be in the future.

  - operation: edit
    mock_time: '2022-01-08 09:31:14' # Same as previous
    data:
      invoice:
        date: '2022-01-08 09:31:14'
    expect:
      delivery:
        processed: false
      delivery_state:
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends: # hasn't been updated yet
        - send_after: '2022-01-07 08:00:00'
          channel: 0
          sent: false
          canceled: true # Should be canceled now
          skipped: false
          failed: false

  - operation: schedule
    mock_time: '2022-01-08 09:31:14' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends:
        - send_after: '2022-01-09 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false