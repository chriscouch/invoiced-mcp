# Tests that "Repeater" step
# - The start date used for the first ScheduledSend is no earlier than (now + days option) (it should never be backdated)
# - The first ScheduledSend be scheduled on the (invoice due date + days option) (if greater than now)
# - ScheduledSends should be removed, added and have their send_after dates updated appropriately according
#   to changes in the chase step options.
# - When the step options are updated, only non-attempted ScheduledSends are updated.

operations:

  # PART 1: Test that ScheduledSends are created for the invoice due date

  - operation: create
    mock_time: '2022-01-01 14:51:12' # Time chosen at random
    data:
      invoice:
        due_date: '2022-01-07 14:51:12'
        items:
          - quantity: 1
            unit_cost: 100
      delivery:
        chase_schedule:
          - trigger: 3
            # Option specifies a two day repeater which happens 3 times.
            options:
              hour: 8
              days: 2
              repeats: 3
              email: true
              sms: false
              letter: false
    expect:
      delivery:
        processed: false
      delivery_state:
        # 3 scheduled sends since it repeats 3 times
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-11 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-13 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends: []

  - operation: schedule
    mock_time: '2022-01-01 14:51:12' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-11 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-13 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends:
        - send_after: '2022-01-09 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-11 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-13 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false

    # PART 2: Test that the ScheduledSends are updated to be sent starting (now + days option) if the invoice
    # due date is edited to be in the past.
    # Also tests that the number of sends is cut down if the option is edited.

  - operation: edit
    mock_time: '2022-01-01 14:51:12' # Same as previous
    data:
      invoice:
        due_date: '2022-01-01 14:51:12'
      delivery:
        chase_schedule:
          - id: 0 # Refers to an index not the actual id. See test suite for more detail.
            trigger: 3
            options:
              hour: 8
              days: 2
              repeats: 2 # Cut this down to 2 to test that the last ScheduledSend is removed.
              email: true
              sms: false
              letter: false
    expect:
      delivery:
        processed: false
      delivery_state:
        - state:
            - date: '2022-01-03 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-05 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends: # not updated yet
        - send_after: '2022-01-09 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-11 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-13 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false


  - operation: schedule
    mock_time: '2022-01-01 14:51:12' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-03 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-05 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends:
        - send_after: '2022-01-03 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-05 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false

    # PART 3: Test that the ScheduledSends are updated to be sent starting (due date + days option) if the invoice
    # due date is edited to be in the future.
    # Also tests that the number of sends is increased if the option is edited.

  - operation: edit
    mock_time: '2022-01-01 14:51:12' # Same as previous
    data:
      invoice:
        due_date: '2022-01-07 14:51:12'
      delivery:
        chase_schedule:
          - id: 0 # Refers to an index not the actual id. See test suite for more detail.
            trigger: 3
            options:
              hour: 8
              days: 2
              repeats: 3 # Increase to show that a new ScheduledSend is created
              email: true
              sms: false
              letter: false
    expect:
      delivery:
        processed: false
      delivery_state:
        # 3 scheduled sends since it repeats 3 times
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-11 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-13 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends: # not updated yet
        - send_after: '2022-01-03 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-05 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false

  - operation: schedule
    mock_time: '2022-01-01 14:51:12' # Same as previous
    expect:
      delivery:
        processed: true
      delivery_state:
        - state:
            - date: '2022-01-09 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-11 08:00:00'
              skipped: false
              sent:
                email: false
            - date: '2022-01-13 08:00:00'
              skipped: false
              sent:
                email: false
      scheduled_sends:
        - send_after: '2022-01-09 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-11 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
        - send_after: '2022-01-13 08:00:00'
          channel: 0
          sent: false
          canceled: false
          skipped: false
          failed: false
